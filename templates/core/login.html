{% extends "core/base.html" %}
{% load static %}

{% block extra_head %}
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'core/css/login.css' %}">
{% endblock %}

{% block title %}Inicia Sesión{% endblock %}

{% block content %}

<header class="site-header" role="banner">
    <div class="header-inner">
      <a href="/" class="brand" aria-label="Inicio">
        <img src="{% static 'core/img/logo.png' %}" alt="Logo" class="brand-logo">
      </a>
      <nav class="header-nav" aria-label="Navegación principal">
        <a href="{% url 'inicio' %}" class="nav-link">Home</a>
      </nav>
    </div>
</header>

<div class="login-outer">
  <div class="login-hero" aria-hidden="true"></div>

  <div class="auth-wrapper">
    <section class="auth-card" aria-labelledby="auth-title">
    <h1 id="auth-title" class="auth-title">Inicia Sesión</h1>

<!-- ERRORES DEVUELTOS POR PYTHON -->
{% if errors %}
<div class="messages-box">
    {% if errors.email %}
        <div class="alert-message error">{{ errors.email }}</div>
    {% endif %}
    {% if errors.password %}
        <div class="alert-message error">{{ errors.password }}</div>
    {% endif %}
</div>
{% endif %}

      <ul class="role-tabs" role="tablist" aria-label="Tipo de usuario">
        <li class="role-tab active" role="tab" tabindex="0" aria-selected="true" data-role="cliente">Cliente</li>
        <li class="role-tab" role="tab" tabindex="0" aria-selected="false" data-role="empresa">Empresa</li>
        <li class="role-tab" role="tab" tabindex="0" aria-selected="false" data-role="operador">Operador</li>
        <li class="role-tab" role="tab" tabindex="0" aria-selected="false" data-role="administrador">Administrador</li>
      </ul>

      <form method="post" action="{% url 'login' %}" class="auth-form" novalidate>
        {% csrf_token %}
        <input type="hidden" name="role" id="role-input" value="cliente">

        <input class="form-control form-input" 
               name="username" 
               type="email" 
               placeholder="Email" 
               required 
               autocomplete="username">

        <input class="form-control form-input" 
               name="password" 
               type="password" 
               placeholder="Contraseña" 
               required 
               autocomplete="current-password">

        <label class="checkbox-label">
          <input class="form-check-input" type="checkbox" name="remember">
          <span>Recordarme</span>
        </label>

        <div class="btn-wrap">
          <button type="submit" class="btn-submit">INGRESAR</button>
        </div>

        <a class="forgot-link" href="{% url 'password_reset' %}">¿Olvidaste tu contraseña?</a>

        <!-- El link se oculta según el tipo de usuario -->
        <a id="register-link" href="{% url 'registro_cliente' %}">Regístrate aquí</a>

      </form>
    </section>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {

  const tabs = Array.from(document.querySelectorAll('.role-tab'));
  const roleInput = document.getElementById('role-input');
  const registerLink = document.getElementById('register-link');

  function activateTab(tab) {

    tabs.forEach(t => {
      t.classList.remove('active');
      t.setAttribute('aria-selected', 'false');
    });

    tab.classList.add('active');
    tab.setAttribute('aria-selected', 'true');

    roleInput.value = tab.dataset.role;
    const rol = tab.dataset.role;

    // -----------------------------
    // LÓGICA DE REGISTRO PERMITIDO
    // -----------------------------
    if (rol === 'cliente') {
      registerLink.style.display = 'inline';
      registerLink.href = "{% url 'registro_cliente' %}";
    }
    else if (rol === 'empresa') {
      registerLink.style.display = 'inline';
      registerLink.href = "{% url 'registro_empresa' %}";
    }
    else if (rol === 'operador') {
      registerLink.style.display = 'inline';
      registerLink.href = "{% url 'registro_operador' %}";
    }
    else {
      // administrador
      registerLink.style.display = 'none';
    }

    tab.focus();
  }

  tabs.forEach((tab, idx) => {
    tab.addEventListener('click', () => activateTab(tab));

    tab.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        activateTab(tab);
      } 
      else if (e.key === 'ArrowRight') {
        e.preventDefault();
        tabs[(idx + 1) % tabs.length].focus();
      } 
      else if (e.key === 'ArrowLeft') {
        e.preventDefault();
        tabs[(idx - 1 + tabs.length) % tabs.length].focus();
      }
    });
  });

  // Activar la pestaña inicial
  const initialTab = document.querySelector('.role-tab.active') || tabs[0];
  activateTab(initialTab);

});

// Detecta mensajes de error y marca inputs

document.addEventListener("DOMContentLoaded", function () {
    const errorMessages = document.querySelectorAll(".alert-message.error");

    if (errorMessages.length > 0) {
        const emailInput = document.querySelector("input[name='username']");
        const passInput = document.querySelector("input[name='password']");

        errorMessages.forEach(msg => {
            if (msg.innerText.toLowerCase().includes("correo")) {
                emailInput.classList.add("input-error");
            }
            if (msg.innerText.toLowerCase().includes("contraseña")) {
                passInput.classList.add("input-error");
            }
        });
    }
});

if (errorMessages.length > 0) {
    const emailInput = document.querySelector("input[name='username']");
    const passInput = document.querySelector("input[name='password']");

    errorMessages.forEach(msg => {
        if (msg.innerText.includes("correo")) {
            emailInput.classList.add("input-error");
        }
        if (msg.innerText.includes("contraseña")) {
            passInput.classList.add("input-error");
        }
        if (msg.innerText.includes("tipo seleccionado")) {
            emailInput.classList.add("input-error");
        }
    });
}


</script>

{% endblock %}
