{% extends "core/base.html" %}
{% load static %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'core/css/registro_empresa.css' %}">
{% endblock %}

{% block content %}
<header class="site-header">
    <div class="header-inner">
        <a href="/" class="brand">
            <img src="{% static 'core/img/logo.png' %}" class="brand-logo" alt="Logo">
        </a>
        <nav class="header-nav">
            <a href="{% url 'inicio' %}" class="nav-link">Home</a>
        </nav>
    </div>
</header>

<div class="registro-container">
    <div class="form-card">
        <h2 class="titulo">Registro de Empresa</h2>

        <!-- ✅ Mostrar mensajes Django -->
        {% if messages %}
            <div class="messages">
                {% for message in messages %}
                    <div class="msg {{ message.tags }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}

       <form id="formEmpresa" method="POST" action="{% url 'usuarios:registro_empresa' %}" enctype="multipart/form-data" novalidate>

            {% csrf_token %}

            <!-- REPRESENTANTE -->
            <h3 class="seccion-titulo">Datos del Representante Legal</h3>

            <label>Nombre completo *</label>
            <input type="text" name="nombre_representante" required>

            <label>Correo electrónico *</label>
            <input type="email" name="email" required>

            <label>Teléfono *</label>
            <div class="phone-row">
                <select name="country_code" id="country_code" class="select-country">
                    <option value="+57" data-digits="10">Colombia +57</option>
                    <option value="+1" data-digits="10">USA +1</option>
                    <option value="+34" data-digits="9">España +34</option>
                </select>
                <input type="tel" name="telefono" id="telefono" required>
            </div>

            <label>Contraseña *</label>
            <input type="password" name="password" id="password" required>

            <label>Confirmar contraseña *</label>
            <input type="password" name="password2" id="password2" required>
            <div class="pw-indicator" id="pw_indicator"></div>

            <!-- EMPRESA -->
            <h3 class="seccion-titulo">Datos de la Empresa</h3>

            <label>Razón Social *</label>
            <input type="text" name="razon_social" required>

            <label>NIT *</label>
            <input type="text" name="nit" id="nit" required>

            <label>Dirección *</label>
            <input type="text" name="direccion" required>

            <label>Ciudad *</label>
            <input type="text" name="ciudad" required>

            <!-- DOCUMENTOS -->
            <h3 class="seccion-titulo">Documentos (RUT, Cámara, Licencia)</h3>

            <label>RUT (PDF/JPG/PNG) *</label>
            <input type="file" name="rut" id="rut" class="doc" accept=".pdf,.jpg,.jpeg,.png" required>
            <div class="help">Max 5MB. Tipos permitidos: PDF, JPG, JPEG, PNG.</div>

            <label>Cámara de Comercio (PDF/JPG/PNG) *</label>
            <input type="file" name="camara_comercio" id="camara" class="doc" accept=".pdf,.jpg,.jpeg,.png" required>

            <label>Licencia de Operación (PDF/JPG/PNG) *</label>
            <input type="file" name="licencia_operacion" id="licencia" class="doc" accept=".pdf,.jpg,.jpeg,.png" required>

            <button type="submit" class="btn-submit">Registrar Empresa</button>
        </form>
    </div>
</div>

<script>
const form = document.getElementById('formEmpresa');
const pw = document.getElementById('password');
const pw2 = document.getElementById('password2');
const pwIndicator = document.getElementById('pw_indicator');
const telefono = document.getElementById('telefono');
const countrySelect = document.getElementById('country_code');

const MAX_SIZE = 5 * 1024 * 1024;
const ALLOWED_EXT = ['pdf','jpg','jpeg','png'];

/* ------------------------
   Función general para pintar campos
-------------------------*/
function setState(input, ok) {
    input.classList.remove("input-error", "input-valid");
    input.classList.add(ok ? "input-valid" : "input-error");
}

/* ------------------------
   Validación en tiempo real básica
-------------------------*/
document.querySelectorAll("input[required]").forEach(input => {
    input.addEventListener("input", () => {
        if (input.type !== "file") {
            setState(input, input.value.trim() !== "");
        }
    });
});

/* ------------------------
   Contraseñas
-------------------------*/
pw2.addEventListener('input', () => {
    if (pw.value === pw2.value && pw.value !== "") {
        pwIndicator.textContent = "✅ Coinciden";
        pwIndicator.className = "pw-indicator ok";
        setState(pw2, true);
    } else {
        pwIndicator.textContent = "❌ No coinciden";
        pwIndicator.className = "pw-indicator bad";
        setState(pw2, false);
    }
});

/* ------------------------
   Validación teléfono
-------------------------*/
function validarTelefono(phone, requiredDigits) {
    const digits = phone.replace(/\D/g,'');
    return digits.length === parseInt(requiredDigits,10);
}

telefono.addEventListener("input", () => {
    const selected = countrySelect.options[countrySelect.selectedIndex];
    const ok = validarTelefono(telefono.value, selected.dataset.digits);
    setState(telefono, ok);
});

/* ------------------------
   Validación archivo
-------------------------*/
function validarArchivoInput(inputEl) {
    const f = inputEl.files[0];
    if (!f) return false;

    const ext = f.name.split('.').pop().toLowerCase();
    if (!ALLOWED_EXT.includes(ext)) return false;
    if (f.size > MAX_SIZE) return false;

    return true;
}

document.querySelectorAll("input[type='file']").forEach(fileInput => {
    fileInput.addEventListener("change", () => {
        setState(fileInput, validarArchivoInput(fileInput));
    });
});

/* ------------------------
   VALIDACIÓN FINAL AL ENVIAR
-------------------------*/
form.addEventListener('submit', (e) => {
    let errors = 0;

    // Campos vacíos
    document.querySelectorAll("input[required]").forEach(input => {
        if (input.type !== "file" && input.value.trim() === "") {
            setState(input, false);
            errors++;
        }
    });

    // Contraseña
    if (pw.value !== pw2.value) {
        setState(pw2, false);
        errors++;
    }

    // Teléfono
    const selectedOpt = countrySelect.options[countrySelect.selectedIndex];
    if (!validarTelefono(telefono.value, selectedOpt.dataset.digits)) {
        setState(telefono, false);
        errors++;
    }

    // Archivos
    if (!validarArchivoInput(document.getElementById('rut'))) errors++;
    if (!validarArchivoInput(document.getElementById('camara'))) errors++;
    if (!validarArchivoInput(document.getElementById('licencia'))) errors++;

    if (errors > 0) {
        e.preventDefault();
        alert("Corrige los errores antes de continuar");
    }
});
</script>

{% endblock %}
