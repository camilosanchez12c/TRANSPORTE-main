{% extends "core/base.html" %}
{% load static %}

{% block title %}Restablecer Contraseña{% endblock %}

{% block content %}
<div class="container" style="max-width:600px; margin-top:50px;">
    <h2 class="mb-4">Restablecer contraseña</h2>

    <!-- bloque de mensajes -->
    {% if messages %}
      {% for m in messages %}
        <div class="alert alert-{{ m.tags }}">{% autoescape off %}{{ m }}{% endautoescape %}</div>
      {% endfor %}
    {% endif %}

    <div class="card p-4">
        {# Si se pasó el form (vista auth de Django) -> mostrarlo #}
        {% if form %}
            <form method="post">
                {% csrf_token %}
                {{ form.as_p }}
                <button class="btn btn-success w-100 mt-2">Guardar contraseña</button>
            </form>
        {% else %}
            {# flujo personalizado (token) #}
            <form method="post" id="resetForm">
                {% csrf_token %}
                <input type="hidden" name="token" value="{{ token }}">
                <div class="mb-3">
                    <label for="password1" class="form-label">Nueva contraseña</label>
                    <input id="password1" name="password1" type="password" class="form-control" required>
                    <div class="invalid-feedback">Las contraseñas no coinciden.</div>
                </div>

                <div class="mb-3">
                    <label for="password2" class="form-label">Repetir contraseña</label>
                    <input id="password2" name="password2" type="password" class="form-control" required>
                    <div class="invalid-feedback">Las contraseñas no coinciden.</div>
                </div>

                <div id="matchMsg" style="display:none;" class="mb-3"></div>

                <button type="submit" id="submitBtn" class="btn btn-success w-100" disabled>Guardar contraseña</button>
            </form>

            <script>
                (function(){
                    const p1 = document.getElementById('password1');
                    const p2 = document.getElementById('password2');
                    const btn = document.getElementById('submitBtn');
                    const matchMsg = document.getElementById('matchMsg');

                    function check() {
                        const v1 = p1.value;
                        const v2 = p2.value;

                        // si ambos vacíos -> desactivar
                        if(!v1 && !v2){
                            p1.classList.remove('is-valid','is-invalid');
                            p2.classList.remove('is-valid','is-invalid');
                            matchMsg.style.display = 'none';
                            btn.disabled = true;
                            return;
                        }

                        if(v1 && v2 && v1 === v2){
                            p1.classList.remove('is-invalid'); p2.classList.remove('is-invalid');
                            p1.classList.add('is-valid'); p2.classList.add('is-valid');
                            matchMsg.style.display = 'block';
                            matchMsg.className = 'alert alert-success';
                            matchMsg.innerText = 'Las contraseñas coinciden.';
                            btn.disabled = false;
                        } else {
                            p1.classList.remove('is-valid'); p2.classList.remove('is-valid');
                            p1.classList.add('is-invalid'); p2.classList.add('is-invalid');
                            matchMsg.style.display = 'block';
                            matchMsg.className = 'alert alert-danger';
                            matchMsg.innerText = 'Las contraseñas no coinciden.';
                            btn.disabled = true;
                        }
                    }

                    p1.addEventListener('input', check);
                    p2.addEventListener('input', check);
                })();
            </script>
        {% endif %}
    </div>
</div>
{% endblock %}
